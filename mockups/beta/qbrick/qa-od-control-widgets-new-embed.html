<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="theme-color" content="#000000" />
    <title>Control players from embedded site (Web Component)</title>
  </head>

  <body>
    <div style="margin-bottom: 24px;">
      <label>Player 1 controllers</label>
      <div>
        <button onclick="play()">Play</button>
        <button onclick="pause()">Pause</button>
        <button onclick="mute()">Mute</button>
        <button onclick="unMute()">Unmute</button>
        <button onclick="jumpto10()">Jump to 10 seconds</button>
      </div>
      <div style="margin-top: 12px;">
        <label>Current position: </label>
        <span id="playerPos1">00:00</span>
      </div>
    </div>

    <label><b>Player 1</b></label>
    <div style="margin-bottom: 24px;">
      <qplayer-embed
        title="Video 1"
        data-qplayer-account-id="AccPn4oB8ooNEqDOBpvqxDBIA"
        data-qplayer-media-id="047226d5-00090291-19993686"
        data-qplayer-inline="on"
        data-qplayer-id="player-1"
        data-qplayer-autoplay="false">
      </qplayer-embed>
    </div>

    <label><b>Player 2 (will be paused if player 1 starts to play)</b></label>
    <div style="margin-top: 12px; margin-bottom: 12px;">
      <label>Current position: </label>
      <span id="playerPos2">00:00</span>
    </div>

    <div style="margin-bottom: 24px;">
      <qplayer-embed
        title="Video 2"
        data-qplayer-account-id="AccPn4oB8ooNEqDOBpvqxDBIA"
        data-qplayer-media-id="75a1666f-ce10-46a5-86a1-996a636f39b2"
        data-qplayer-inline="on"
        data-qplayer-id="player-2"
        data-qplayer-autoplay="true"
        data-qplayer-mute="true">
      </qplayer-embed>
    </div>

    <script src="https://play2.qbrick.com/qplayer-beta/qplayer.min.js"></script>

    <script>
      // Prefer the main playback video element; avoid overlay/preview videos.
      function getMainVideo(playerId) {
        const host = document.querySelector(`qplayer-embed[data-qplayer-id="${playerId}"]`);
        if (!host) return null;

        // Video.js "tech" element (your logs show vjs-tech).
        const vjsTech = host.querySelector('video.vjs-tech');
        if (vjsTech) return vjsTech;

        // Fallback: largest visible <video> inside host.
        const vids = Array.from(host.querySelectorAll('video'))
          .filter(v => v.offsetParent !== null); // visible-ish
        vids.sort((a, b) => (b.clientWidth * b.clientHeight) - (a.clientWidth * a.clientHeight));
        return vids[0] || null;
      }

      function fmtTime(seconds) {
        const s = Math.floor(seconds || 0);
        const m = String(Math.floor(s / 60)).padStart(2, '0');
        const r = String(s % 60).padStart(2, '0');
        return `${m}:${r}`;
      }

      // Controller functions used by buttons
      function play() {
        const v = getMainVideo('player-1');
        if (!v) return console.warn('Player 1 main video not found');
        v.play().catch(err => console.warn('Play failed:', err));
      }

      function pause() {
        const v = getMainVideo('player-1');
        if (!v) return console.warn('Player 1 main video not found');
        v.pause();
      }

      function jumpto10() {
        const v = getMainVideo('player-1');
        if (!v) return console.warn('Player 1 main video not found');
        v.currentTime = 10;
      }

      function mute() {
        const v = getMainVideo('player-1');
        if (!v) return console.warn('Player 1 main video not found');
        v.muted = true;
      }

      function unMute() {
        const v = getMainVideo('player-1');
        if (!v) return console.warn('Player 1 main video not found');
        v.muted = false;
        // Optional: restore to a non-zero volume if you want old behavior
        // v.volume = 0.5;
      }

      // Wire up events once videos exist. They might be rendered async.
      function wirePlayerEvents() {
        const v1 = getMainVideo('player-1');
        const v2 = getMainVideo('player-2');

        if (!v1 || !v2) return false;

        // Update UI positions
        v1.addEventListener('timeupdate', () => {
          const el = document.getElementById('playerPos1');
          if (el) el.textContent = fmtTime(v1.currentTime);
        });

        v2.addEventListener('timeupdate', () => {
          const el = document.getElementById('playerPos2');
          if (el) el.textContent = fmtTime(v2.currentTime);
        });

        // Pause player 2 when player 1 starts playing
        v1.addEventListener('play', () => {
          if (!v2.paused) v2.pause();
        });

        // Console diagnostics (optional)
        v1.addEventListener('loadedmetadata', () => console.log('P1 loadedmetadata', { duration: v1.duration }));
        v2.addEventListener('loadedmetadata', () => console.log('P2 loadedmetadata', { duration: v2.duration }));
        v1.addEventListener('pause', () => console.log('P1 pause'));
        v2.addEventListener('pause', () => console.log('P2 pause'));
        v1.addEventListener('volumechange', () => console.log('P1 volumechange', { muted: v1.muted, volume: v1.volume }));
        v2.addEventListener('volumechange', () => console.log('P2 volumechange', { muted: v2.muted, volume: v2.volume }));

        console.log('Player event wiring complete', { v1, v2 });
        return true;
      }

      // Poll briefly until the player has rendered its <video> elements.
      (function init() {
        const started = Date.now();
        const timer = setInterval(() => {
          if (wirePlayerEvents()) {
            clearInterval(timer);
            return;
          }
          if (Date.now() - started > 10000) {
            clearInterval(timer);
            console.warn('Timed out waiting for video elements to appear');
          }
        }, 100);
      })();
    </script>
  </body>
</html>
